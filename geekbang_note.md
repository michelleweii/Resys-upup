https://time.geekbang.org/column/article/295939

### 04 ###

特征其实是对某个行为过程相关信息的抽象表达：因为一个行为过程必须转换成某种数学形式才能被机器学习模型所学习。

但也不能所有情节都当做特征放进模型学习。具体的推荐场景中包含大量冗余的、无用的信息，把它们都考虑进来甚至会损害模型的泛化能力。

> 构建推荐系统特征工程的原则：尽可能地让特征工程抽取出的一组特征，能够保留推荐环境及用户行为过程中的所有“有用“信息，并且尽量摒弃冗余信息。



电影推荐的要素和特征化方式

![img](https://static001.geekbang.org/resource/image/af/5d/af921c7e81984281621729f6e75c1b5d.jpeg)





#### 推荐系统中的常用特征 ####

1. 用户行为数据（最常用、最关键）
2. 用户关系数据
3. 属性、标签类数据
4. 内容类数据
5. 场景信息（上下文信息）





1、户行为在推荐系统中一般分为显性反馈行为（Explicit Feedback）和隐性反馈行为（Implicit Feedback）两种。

不同业务场景下用户行为数据的例子

![img](https://static001.geekbang.org/resource/image/75/06/7523075958d83e9bd08966b77ea23706.jpeg)

隐性反馈行为更重要，主要原因是显性反馈行为的收集难度过大，数据量小。



2、物以类聚，人以群分

用户行为数据是人与物之间的“连接”日志；

用户关系数据就是人与人之间连接的记录

用户关系数据也可以分为“显性”和“隐性”两种，或者称为“强关系”和“弱关系”。用户与用户之间可以通过“关注”“好友关系”等连接建立“强关系”，也可以通过“互相点赞”“同处一个社区”，甚至“同看一部电影”建立“弱关系”。

- 比如可以将用户关系作为召回层的一种物品召回方式；（user-cf）
- 也可以通过用户关系建立关系图，使用 Graph Embedding 的方法生成用户和物品的 Embedding；
- 还可以直接利用关系数据，通过“好友”的特征为用户添加新的属性特征；
- 甚至可以利用用户关系数据直接建立社会化推荐系统。



3、

推荐系统中另外一大类特征来源是属性、标签类数据，本质上都是直接描述用户或者物品的特征。属性和标签的主体可以是用户，也可以是物品

图：属性、标签类数据的分类和来源

![img](https://static001.geekbang.org/resource/image/ba/69/ba044e0033b513d996633de77e11f969.jpeg)



在推荐系统中使用属性、标签类数据，一般是通过 Multi-hot 编码的方式将其转换成特征向量，一些重要的属性标签类特征也可以先转换成 Embedding，比如业界最新的做法是将标签属性类数据与其描述主体一起构建成知识图谱（Knowledge Graph），在其上施以 Graph Embedding 或者 GNN（Graph Neural Network，图神经网络）生成各节点的 Embedding，再输入推荐模型。



4、

相比标签类特征，内容类数据往往是大段的描述型文字、图片，甚至视频。文字信息则更多是通过自然语言处理的方法提取关键词、主题、分类等信息，一旦这些特征被提取出来，就跟处理属性、标签类特征的方法一样，通过 Multi-hot 编码，Embedding 等方式输入推荐系统进行训练。



5、

最后一大类是场景信息，或称为上下文信息（Context），它是描述推荐行为产生的场景的信息。最常用的上下文信息是“时间”和通过 GPS、IP 地址获得的“地点”信息。根据推荐场景的不同，上下文信息的范围极广，除了我们上面提到的时间和地点，还包括“当前所处推荐页面”“季节”“月份”“是否节假日”“天气”“空气质量”“社会大事件”等等。





### 05 ###

> 知道了推荐系统要使用的常用特征有哪些。但这些原始的特征是无法直接提供给推荐模型使用的，因为推荐模型本质上是一个函数，输入输出都是数字或数值型的向量。那么问题来了，像动作、喜剧、爱情、科幻这些电影风格，是怎么转换成数值供推荐模型使用的呢？用户的行为历史又是怎么转换成数值特征的呢？



#### spark ####

Spark 是一个分布式计算平台。所谓分布式，指的是计算节点之间不共享内存，需要通过网络通信的方式交换数据。Spark 最典型的应用方式就是建立在大量廉价的计算节点上，这些节点可以是廉价主机，也可以是虚拟的 Docker Container（Docker 容器）。

Spark 程序由 Manager Node（管理节点）进行调度组织，由 Worker Node（工作节点）进行具体的计算任务执行，最终将结果返回给 Drive Program（驱动程序）。在物理的 Worker Node 上，数据还会分为不同的 partition（数据分片），可以说 partition 是 Spark 的基础数据单元。

![img](https://static001.geekbang.org/resource/image/4a/9b/4ae1153e4daee39985c357ed796eca9b.jpeg)





如何利用 One-hot 编码处理类别型特征

广义上来讲，所有的特征都可以分为两大类。

第一类是类别、ID 型特征——影的风格、ID、标签、导演演员等信息，用户看过的电影 ID、用户的性别、地理位置信息、当前的季节、时间（上午，下午，晚上）、天气等等，这些无法用数字表示的信息全都可以被看作是类别、ID 类特征。

第二类是数值型特征——能用数字直接表示的特征就是数值型特征，典型的包括用户的年龄、收入、电影的播放时长、点击量、点击率等。

> 进行特征处理的目的，是把所有的特征全部转换成一个数值型的特征向量。

对于数值型特征，这个过程非常简单，直接把这个数值放到特征向量上相应的维度上就可以了。但是对于类别、ID 类特征，我们应该怎么处理它们呢？



one-hot——将类别、**ID 型特征**转换成数值向量的一种最典型的编码方式

类别转换：

![img](https://static001.geekbang.org/resource/image/94/15/94f78685d98671648638e330a461ab15.jpeg)

id类转换：

ID 型特征也经常使用 One-hot 编码。比如，用户 U 观看过电影 M，这个行为是一个非常重要的用户特征，那我们应该如何向量化这个行为呢？其实也是使用 One-hot 编码。**假设，我们的电影库中一共有 1000 部电影，电影 M 的 ID 是 310（编号从 0 开始），那这个行为就可以用一个 1000 维的向量来表示，让第 310 维的元素为 1，其他元素都为 0。**

One-hot 编码也可以自然衍生成 **Multi-hot 编码（多热编码）**。比如，对于历史行为序列类、标签特征等数据来说，用户往往会与多个物品产生交互行为，或者一个物品被打上多个标签，这时最常用的特征向量生成方式就是把其转换成 Multi-hot 编码。在 SparrowRecsys 中，因为每个电影都是有多个 Genre（风格）类别的，所以我们就可以用 Multi-hot 编码完成标签到向量的转换。



数值型特征的处理 - 归一化和分桶

一是特征的尺度，二是特征的分布



> 用分桶的方式来解决特征值分布极不均匀的问题。所谓“分桶（Bucketing）”，就是将样本按照某特征的值从高到低排序，然后按照桶的数量找到分位数，将样本分到各自的桶中，再用桶 ID 作为特征值。

怎么理解？







spark分桶的特征处理 QuantileDiscretizer

![img](https://static001.geekbang.org/resource/image/b3/7b/b3b8c959df72ce676ae04bd8dd987e7b.jpeg)







### 06 ###

Embedding 就是用一个数值向量“表示”一个对象（Object）的方法。















